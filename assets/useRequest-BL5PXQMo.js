import{i as _,R as O,S as j,_ as V,T as G,U as Q,V as L,K as W,h as C,n as h,W as X,X as Y,Y as Z,Z as z,r as J,B as k,E as K,$ as ee}from"./index-DOwwAGMQ.js";const x=new Map,te=(t,e,n)=>{const r=x.get(t);r!=null&&r.timer&&clearTimeout(r.timer);let s;e>-1&&(s=setTimeout(()=>{x.delete(t)},e)),x.set(t,{...n,timer:s})},ne=t=>x.get(t),B=new Map,re=t=>B.get(t),ie=(t,e)=>{B.set(t,e),e.then(n=>(B.delete(t),n)).catch(n=>{throw B.delete(t),n})},T={},se=[],ae=(t,e)=>{T[t]&&(T[t].forEach(n=>n(e)),se.forEach(n=>n({type:t,data:e})))},$=(t,e)=>(T[t]||(T[t]=[]),T[t].push(e),function(){const r=T[t].indexOf(e);T[t].splice(r,1)}),oe=(t,{cacheKey:e,cacheTime:n=5*60*1e3,staleTime:r=0,setCache:s,getCache:a})=>{const i=_(),o=_(),l=(u,c)=>{s?s(c):te(u,n,c),ae(u,c.data)},d=(u,c=[])=>a?a(c):ne(u);return O(()=>{if(!e)return;const u=d(e);u&&Object.hasOwnProperty.call(u,"data")&&(t.state.data=u.data,t.state.params=u.params,(r===-1||new Date().getTime()-u.time<=r)&&(t.state.loading=!1)),i.value=$(e,c=>{t.setState({data:c})})}),j(()=>{var u;(u=i.value)==null||u.call(i)}),e?{name:"cachePlugin",onBefore:u=>{const c=d(e,u);return!c||!Object.hasOwnProperty.call(c,"data")?{}:r===-1||new Date().getTime()-c.time<=r?{loading:!1,data:c==null?void 0:c.data,returnNow:!0}:{data:c==null?void 0:c.data}},onRequest:(u,c)=>{let v=re(e);return v&&v!==o.value?{servicePromise:v}:(v=u(...c),o.value=v,ie(e,v),{servicePromise:v})},onSuccess:(u,c)=>{var v;e&&((v=i.value)==null||v.call(i),l(e,{data:u,params:c,time:new Date().getTime()}),i.value=$(e,f=>{t.setState({data:f})}))},onMutate:u=>{var c;e&&((c=i.value)==null||c.call(i),l(e,{data:u,params:t.state.params,time:new Date().getTime()}),i.value=$(e,v=>{t.setState({data:v})}))}}:{}};var ue=V,le=function(){return ue.Date.now()},ce=le,fe=/\s/;function de(t){for(var e=t.length;e--&&fe.test(t.charAt(e)););return e}var ve=de,me=ve,he=/^\s+/;function ge(t){return t&&t.slice(0,me(t)+1).replace(he,"")}var be=ge,_e=G,pe=Q,Pe="[object Symbol]";function Re(t){return typeof t=="symbol"||pe(t)&&_e(t)==Pe}var Ee=Re,Te=be,N=L,Se=Ee,H=NaN,Oe=/^[-+]0x[0-9a-f]+$/i,we=/^0b[01]+$/i,Ae=/^0o[0-7]+$/i,De=parseInt;function ye(t){if(typeof t=="number")return t;if(Se(t))return H;if(N(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=N(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=Te(t);var n=we.test(t);return n||Ae.test(t)?De(t.slice(2),n?2:8):Oe.test(t)?H:+t}var xe=ye,Be=L,U=ce,I=xe,Ce="Expected a function",Fe=Math.max,$e=Math.min;function Ue(t,e,n){var r,s,a,i,o,l,d=0,u=!1,c=!1,v=!0;if(typeof t!="function")throw new TypeError(Ce);e=I(e)||0,Be(n)&&(u=!!n.leading,c="maxWait"in n,a=c?Fe(I(n.maxWait)||0,e):a,v="trailing"in n?!!n.trailing:v);function f(m){var P=r,E=s;return r=s=void 0,d=m,i=t.apply(E,P),i}function w(m){return d=m,o=setTimeout(b,e),u?f(m):i}function g(m){var P=m-l,E=m-d,R=e-P;return c?$e(R,a-E):R}function p(m){var P=m-l,E=m-d;return l===void 0||P>=e||P<0||c&&E>=a}function b(){var m=U();if(p(m))return A(m);o=setTimeout(b,g(m))}function A(m){return o=void 0,v&&r?f(m):(r=s=void 0,i)}function F(){o!==void 0&&clearTimeout(o),d=0,r=l=s=o=void 0}function D(){return o===void 0?i:A(U())}function S(){var m=U(),P=p(m);if(r=arguments,s=this,l=m,P){if(o===void 0)return w(l);if(c)return clearTimeout(o),o=setTimeout(b,e),f(l)}return o===void 0&&(o=setTimeout(b,e)),i}return S.cancel=F,S.flush=D,S}var q=Ue;const je=W(q),Le=(t,{debounceWait:e,debounceLeading:n,debounceTrailing:r,debounceMaxWait:s})=>{const a=_(),i=C(()=>{const o={},l=h(n),d=h(r),u=h(s);return l!==void 0&&(o.leading=l),d!==void 0&&(o.trailing=d),u!==void 0&&(o.maxWait=u),o});return O(o=>{if(h(e)){const l=t.runAsync.bind(t);a.value=je(d=>{d()},h(e),i.value),t.runAsync=(...d)=>new Promise((u,c)=>{var v;(v=a.value)==null||v.call(a,()=>{l(...d).then(u).catch(c)})}),o(()=>{var d;(d=a.value)==null||d.cancel(),t.runAsync=l})}}),h(e)?{name:"debouncePlugin",onCancel:()=>{var o;(o=a.value)==null||o.cancel()}}:{}},Ne=(t,{loadingDelay:e})=>{const n=_();if(!h(e))return{};const r=()=>{n.value&&clearTimeout(n.value)};return{name:"loadingDelayPlugin",onBefore:()=>(r(),n.value=setTimeout(()=>{t.setState({loading:!0})},h(e)),{loading:!1}),onFinally:()=>{r()},onCancel:()=>{r()}}},He=(t,{pollingInterval:e,pollingWhenHidden:n=!0,pollingErrorRetryCount:r=-1})=>{const s=_(),a=_(),i=_(0),o=()=>{var l;s.value&&clearInterval(s.value),(l=a.value)==null||l.call(a)};return O(()=>{h(e)||o()}),h(e)?{name:"pollingPlugin",onBefore:()=>{o()},onError:()=>{i.value+=1},onSuccess:()=>{i.value=0},onFinally:()=>{r===-1||r!==-1&&i.value<=r?s.value=setTimeout(()=>{!n&&!X()?a.value=Y(()=>{t.refresh()}):t.refresh()},h(e)):i.value=0},onCancel:()=>{o()}}:{}};function Ie(t,e){let n=!1;return(...r)=>{n||(n=!0,t(...r),setTimeout(()=>{n=!1},e))}}const Me=(t,{refreshOnWindowFocus:e,focusTimespan:n=5e3})=>{const r=_(),s=()=>{var a;(a=r.value)==null||a.call(r)};return O(a=>{if(h(e)){const i=Ie(t.refresh.bind(t),h(n));r.value=Z(()=>{i()})}a(()=>{s()})}),j(()=>{s()}),{name:"refreshOnWindowFocusPlugin"}},We=(t,{retryInterval:e,retryCount:n})=>{const r=_(),s=_(0),a=_(!1);return n?{name:"retryPlugin",onBefore:()=>{a.value||(s.value=0),a.value=!1,r.value&&clearTimeout(r.value)},onSuccess:()=>{s.value=0},onError:()=>{if(s.value+=1,n===-1||s.value<=n){const i=e??Math.min(1e3*2**s.value,3e4);r.value=setTimeout(()=>{a.value=!0,t.refresh()},i)}else s.value=0},onCancel:()=>{s.value=0,r.value&&clearTimeout(r.value)}}:{}};var qe=q,Ve=L,Ge="Expected a function";function Qe(t,e,n){var r=!0,s=!0;if(typeof t!="function")throw new TypeError(Ge);return Ve(n)&&(r="leading"in n?!!n.leading:r,s="trailing"in n?!!n.trailing:s),qe(t,e,{leading:r,maxWait:e,trailing:s})}var Xe=Qe;const Ye=W(Xe),Ze=(t,{throttleWait:e,throttleLeading:n,throttleTrailing:r})=>{const s=C(()=>{const i={};return h(n)!==void 0&&(i.leading=h(n)),h(r)!==void 0&&(i.trailing=h(r)),i}),a=C(()=>Ye(i=>{i()},h(e),s.value));return O(i=>{if(h(e)){const o=t.runAsync.bind(t);t.runAsync=(...l)=>new Promise((d,u)=>{var c;(c=a.value)==null||c.call(a,()=>{o(...l).then(d).catch(u)})}),i(()=>{var l;t.runAsync=o,(l=a.value)==null||l.cancel()})}}),h(e)?{name:"throttlePlugin",onCancel:()=>{var i;(i=a.value)==null||i.cancel()}}:{}},M=t=>typeof t=="function",ze=t=>typeof t=="boolean";var Je=Object.defineProperty,ke=(t,e,n)=>e in t?Je(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,y=(t,e,n)=>(ke(t,typeof e!="symbol"?e+"":e,n),n);class Ke{constructor(e,n,r,s={}){y(this,"pluginImpls"),y(this,"count",0),y(this,"state",{loading:!1,params:void 0,data:void 0,error:void 0}),y(this,"previousValidData"),this.serviceRef=e,this.options=n,this.setUpdateData=r,this.initState=s,this.state={...this.state,loading:!n.manual,...s}}setState(e={}){this.state={...this.state,...e},this.setUpdateData(this.state)}setData(e,n){console.warn("Please use 'setFetchState' instead of 'setData'"),n instanceof Array?n.forEach(r=>{this.state[r]=e,this.setUpdateData(e,r)}):(this.state[n]=e,this.setUpdateData(e,n))}setFetchState(e,n){n instanceof Array?n.forEach(r=>{this.state[r]=e,this.setUpdateData(e,r)}):(this.state[n]=e,this.setUpdateData(e,n))}runPluginHandler(e,...n){var r,s,a;const i=(a=(s=(r=this.pluginImpls)==null?void 0:r.map(o=>{var l;return(l=o[e])==null?void 0:l.call(o,...n)}))!=null?s:[])==null?void 0:a.filter(Boolean);return Object.assign({},...i)}async runAsync(...e){var n,r,s,a,i,o,l,d,u,c,v;this.count+=1;const f=this.count,{stopNow:w=!1,returnNow:g=!1,...p}=this.runPluginHandler("onBefore",e);if(w)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...p}),g)return Promise.resolve(p.data);try{(r=(n=this.options).onBefore)==null||r.call(n,e)}catch(b){return this.setState({error:b,loading:!1}),(a=(s=this.options).onError)==null||a.call(s,b,e),this.runPluginHandler("onError",b,e),new Promise(()=>{})}try{let{servicePromise:b}=this.runPluginHandler("onRequest",this.serviceRef.value,e);const A=D=>{var S,m,P,E;if(f!==this.count)return new Promise(()=>{});const R=this.options.formatResult?this.options.formatResult(D):D;return this.setState({data:R,error:void 0,loading:!1}),(m=(S=this.options).onSuccess)==null||m.call(S,R,e),this.runPluginHandler("onSuccess",R,e),this.previousValidData=R,(E=(P=this.options).onFinally)==null||E.call(P,e,R,void 0),f===this.count&&this.runPluginHandler("onFinally",e,R,void 0),R};b||(b=this.serviceRef.value(...e));const F=await b;return A(F)}catch(b){if(f!==this.count)return new Promise(()=>{});throw this.setState({error:b,loading:!1}),(o=(i=this.options).onError)==null||o.call(i,b,e),this.runPluginHandler("onError",b,e),(M((l=this.options)==null?void 0:l.rollbackOnError)&&((d=this.options)!=null&&d.rollbackOnError(e))||ze((u=this.options)==null?void 0:u.rollbackOnError)&&this.options.rollbackOnError)&&this.setState({data:this.previousValidData}),(v=(c=this.options).onFinally)==null||v.call(c,e,void 0,b),f===this.count&&this.runPluginHandler("onFinally",e,void 0,b),b}}run(...e){this.runAsync(...e).catch(n=>{this.options.onError||console.error(n)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){const n=M(e)?e(this.state.data):e;this.runPluginHandler("onMutate",n),this.setState({data:n})}}const et=Symbol("USEREQUEST_GLOBAL_OPTIONS_PROVIDE_KEY");function tt(t){return Object.keys(t).filter(n=>["data","loading","params","error"].includes(n)).length===4}function nt(t,e={},n=[]){const r=z(et,{}),{initialData:s=void 0,manual:a=!1,ready:i=!0,...o}={...r??{},...e??{}},l={manual:a,ready:i,...o},d=_(t),u=J({data:s,loading:!1,params:void 0,error:void 0}),c=(g,p)=>{p?u[p]=g:tt(g)&&(u.data=g.data,u.loading=g.loading,u.error=g.error,u.params=g.params)},v=n.map(g=>{var p;return(p=g==null?void 0:g.onInit)==null?void 0:p.call(g,l)}).filter(Boolean),f=new Ke(d,l,c,Object.assign({},...v,u));f.options=l,f.pluginImpls=n.map(g=>g(f,l));const w=C(()=>k(i)?i.value:i);if(O(()=>{if(!a){const g=f.state.params||e.defaultParams||[];w.value&&f.options.refreshDeps===!0&&d.value&&f.run(...g)}}),!a&&f.options.refreshDeps!==!0){const g=f.state.params||e.defaultParams||[];h(i)&&f.run(...g)}return j(()=>{f.cancel()}),{...K(u),cancel:f.cancel.bind(f),refresh:f.refresh.bind(f),refreshAsync:f.refreshAsync.bind(f),run:f.run.bind(f),runAsync:f.runAsync.bind(f),mutate:f.mutate.bind(f)}}const rt=(t,e)=>function(r,s={},a=[]){let i=t;const o=e||[];for(let l=o.length;l--;)i=o[l](i);return i(r,s,a)};function st(t,e,n){var r;const s=(r=[null,Le,Ne,He,Me,Ze,ee,oe,We])==null?void 0:r.filter(Boolean);return rt(nt,e==null?void 0:e.use)(t,e,[...n||[],...s])}export{st as u};
